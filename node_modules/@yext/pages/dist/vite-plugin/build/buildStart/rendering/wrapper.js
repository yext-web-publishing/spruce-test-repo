import { getLang } from "../../../../common/src/template/head.js";
import {
  getHydrationTemplate,
  getServerTemplatePlugin
} from "../../../../common/src/template/hydration.js";
import path from "node:path";
const reactWrapper = async (props, templateModuleInternal, hydrate, pluginRenderTemplates, manifest, projectStructure) => {
  if (!manifest) {
    throw new Error("Manifest is undefined");
  }
  const headConfig = templateModuleInternal.getHeadConfig ? templateModuleInternal.getHeadConfig(props) : void 0;
  const templateFilepath = findOriginalTemplatePathInManifest(
    projectStructure,
    manifest,
    `${templateModuleInternal.templateName}.tsx`
  );
  if (!templateFilepath) {
    return;
  }
  let clientHydrationString;
  if (hydrate) {
    clientHydrationString = getHydrationTemplate(
      pluginRenderTemplates.client,
      manifest.clientPaths[templateModuleInternal.templateName],
      props
    );
  }
  const serverHtml = await pluginRenderTemplates.server.render({
    Page: templateModuleInternal.default,
    pageProps: props
  });
  const html = pluginRenderTemplates.server.indexHtml.replace(
    pluginRenderTemplates.server.replacementTag,
    serverHtml
  );
  const clientInjectedServerHtml = getServerTemplatePlugin(
    clientHydrationString,
    html,
    templateFilepath,
    manifest.bundlerManifest,
    getLang(headConfig, props),
    headConfig
  );
  return clientInjectedServerHtml;
};
const findOriginalTemplatePathInManifest = (projectStructure, manifest, templateName) => {
  const templatesRoot = path.join(
    projectStructure.config.rootFolders.source,
    projectStructure.config.subfolders.templates
  );
  if (projectStructure.config.scope) {
    const scopedFilepath = path.join(
      templatesRoot,
      projectStructure.config.scope,
      templateName
    );
    if (Object.keys(manifest.bundlerManifest).some(
      (key) => key.includes(scopedFilepath)
    )) {
      return scopedFilepath;
    }
  }
  const filepath = path.join(templatesRoot, templateName);
  if (Object.keys(manifest.bundlerManifest).some((key) => key.includes(filepath))) {
    return filepath;
  }
  console.error(`Template ${templateName} not found in manifest`);
};
export {
  findOriginalTemplatePathInManifest,
  reactWrapper
};
